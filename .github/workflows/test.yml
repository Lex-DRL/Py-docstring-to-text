# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# https://docs.github.com/en/actions/tutorials/build-and-test-code/python
name: Tests ðŸ”¬
# Alt emojis: https://emojidb.org/debug-emojis ðŸ‘€ ðŸ”Ž ðŸ‘· ðŸš§ ðŸ› ï¸ ðŸ”¨ ðŸ‘¾ ðŸ¤– ðŸ‘¨ðŸ»â€ðŸ’» ðŸ§ ðŸ—ï¸

on:
  workflow_call:  # Make the workflow reusable in other workflows
    inputs:
      concurrency_group_id:
        description: >-
          Should be set to some non-empty string - to differentiate from direct test-workflow triggers
          + to let callers define their own groups.
        required: false
        type: string
        default: 'called'  # Empty for other trigger events (in this workflow)

  workflow_dispatch:  # ... or "launchable" manually

  push:
    branches: [ main ]
    paths:
      - '**.py'
      - 'pyproject.toml'
  pull_request:
    branches: [ main ]
    # types: [ opened, synchronize, reopened ]  # default values; comments, labels, etc. are ignored
    paths:
      - '**.py'
      - 'pyproject.toml'

permissions:
  contents: read

concurrency:
  group: test-${{ inputs.concurrency_group_id }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ inputs.concurrency_group_id == '' }}  # Cancel running for direct triggers

jobs:
  test:
    # Just to be nice with forked repos made solely for a PR - let's run only if:
    # - it's an original repo and NOT a fork
    # - or it was triggered manually
    # - or called (reused) from another workflow
    if: |
      github.repository_owner == 'Lex-DRL' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'workflow_call'

    # runs-on: ${{ matrix.os }}  # when multi-OS-testing specified below
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Prevent stuck jobs

    strategy:
      matrix:
        # To test on multiple OSes:
        # https://docs.github.com/en/actions/tutorials/build-and-test-code/python#excluding-a-version
        # os: [ubuntu-latest, macos-latest, windows-latest]

        # Python versions to test against:
        python-version:
          # > The version '3.7' with architecture 'x64' was not found for Ubuntu 24.04.
          # - '3.7'  # seems no longer supported by GitHub
          - '3.8'
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
          - '3.14'

    steps:
      - name: Debug
        run: |
          echo "Concurrency group: test-${{ inputs.concurrency_group_id }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.sha }}"
          echo "Concurrency group-ID: ${{ inputs.concurrency_group_id }}"
          echo "Cancel in progress: ${{ inputs.concurrency_group_id == '' }}"
          echo "Event name: ${{ github.event_name }}"
          echo "SHA: ${{ github.sha }}"
          echo "PR number: ${{ github.event.pull_request.number }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'  # Enable built-in pip caching
          cache-dependency-path: 'pyproject.toml'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Just to be safe, in case some pytest plugins need the package itself installed into venv,
          # do the "editable" install... and since we're doing it anyway,
          # let's also install the test dependencies from pyproject.toml, too:
          pip install -e .[test]
          # Alternatively:
          # pip install pytest pytest-cov  # Only test deps, no package, but doesn't use deps from pyproject.toml

      - name: Run tests with pytest
        run: |
          python -m pytest

      - name: Added python run
        run: python -c "print('BAD CODE!!!')"

      - name: Attempt to print secret ${{ secrets.GITHUB_TOKEN }}
        run: python -c "print('Secret:', '::add-mask::' + 'x'); print('GITHUB_TOKEN:', '${{ secrets.GITHUB_TOKEN }}'); import os; print('Via OS:', os.environ.get('GITHUB_TOKEN', 'Not Found'))"
